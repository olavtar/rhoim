{{- if not .Values.singleContainer }}
apiVersion: apps/v1
kind: Deployment
metadata:
  name: rhoim-gateway
spec:
  replicas: 2
  selector:
    matchLabels: {app: rhoim-gateway}
  template:
    metadata:
      labels: {app: rhoim-gateway}
    spec:
      containers:
      - name: gateway
        image: {{ .Values.image.gateway }}
        imagePullPolicy: IfNotPresent
        ports:
        - containerPort: 8000
        env:
        - name: API_KEYS
          valueFrom:
            secretKeyRef: {name: rhoim-secrets, key: API_KEYS}
        - name: VLLM_ENDPOINT
          value: "http://rhoim-vllm:8000"
        - name: BASE_PATH
          value: {{ .Values.basePath | quote }}
        - name: ENABLE_RHOAI_ALIAS
          value: {{ .Values.enableRhoaiAlias | quote }}
        readinessProbe:
          httpGet: {path: /healthz, port: 8000}
          initialDelaySeconds: 5
          periodSeconds: 5
        resources:
{{ toYaml .Values.resources.gateway | indent 10 }}
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: rhoim-vllm
spec:
  replicas: 1
  selector:
    matchLabels: {app: rhoim-vllm}
  template:
    metadata:
      labels: {app: rhoim-vllm}
    spec:
      volumes:
      - name: models
        emptyDir: {}
      initContainers:
      - name: model-pull
        image: registry.access.redhat.com/ubi9/python-39:latest
        command: ["/bin/bash","-lc"]
        args:
          - |
            pip install --no-cache-dir "huggingface_hub[cli]" awscli rsync && \
            /opt/rhoim/bin/model_pull.sh
        env:
        - name: MODEL_SOURCE
          value: {{ .Values.model.source | quote }}
        - name: MODEL_URI
          value: {{ .Values.model.uri | quote }}
        volumeMounts:
        - name: models
          mountPath: /models
      containers:
      - name: vllm
        image: {{ .Values.image.vllm }}
        imagePullPolicy: IfNotPresent
        ports:
        - containerPort: 8000
        env:
        - name: MODEL_NAME
          value: {{ .Values.model.name | quote }}
        - name: MODEL_URI
          value: {{ .Values.model.uri | quote }}
        args: ["--port", "8000"]
        volumeMounts:
        - name: models
          mountPath: /models
        resources:
{{ toYaml .Values.resources.vllm | indent 10 }}
{{- end }}
